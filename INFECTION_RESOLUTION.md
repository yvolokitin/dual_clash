# Infection Resolution Logic

This document describes the centralized ownership transition logic (Axis 1 from `GAMEPLAY_MODES_DESIGN.md`) implemented in the codebase. It builds on the already-centralized adjacency provider and preserves current gameplay behavior by default.


## Abstraction Overview
- Enum: `InfectionResolutionMode`
  - `neutralIntermediary`
  - `directTransfer`
- Central provider: `InfectionResolution` (file: `lib/logic/infection_resolution.dart`)
  - `static InfectionResolutionMode mode` — global default, set to `neutralIntermediary` to preserve current behavior.
  - `applyOwnershipTransitions(...)` — single source of truth that applies transitions to an iterable of affected neighbor coordinates produced by the adjacency provider.
  - `applyUsingDefaults(...)` — convenience wrapper using the global resolution mode and the current adjacency provider.
- Integration point: `RulesEngine.place(...)`
  - Places the attacker on an empty target cell, then delegates all neighbor changes to `InfectionResolution.applyUsingDefaults(...)` using the centralized adjacency provider.


## Step-by-step flow: neutralIntermediary (default)
1. Preconditions
   - Target cell `(r, c)` is in bounds and `empty`.
2. Placement
   - Set `board[r][c] = attacker`.
3. Determine affected neighbors
   - Use `Adjacency.neighborsOf(r, c)` (default is `orthogonal4`).
4. Apply transitions (for each neighbor)
   - Ignore `bomb` and `wall` cells.
   - If neighbor is `empty` or already the `attacker`, do nothing.
   - If neighbor is `neutral` (gray) → set to `attacker`.
   - Else (any opponent color) → set to `neutral` (gray).
5. Result
   - Matches the current baseline described in `GAMEPLAY_ANALYSIS.md` (enemies→gray; gray→attacker; bombs/walls ignored).


## Step-by-step flow: directTransfer
1. Preconditions
   - Target cell `(r, c)` is in bounds and `empty`.
2. Placement
   - Set `board[r][c] = attacker`.
3. Determine affected neighbors
   - Use `Adjacency.neighborsOf(r, c)` (default remains `orthogonal4`).
4. Apply transitions (for each neighbor)
   - Ignore `bomb` and `wall` cells.
   - If neighbor is `empty` or already the `attacker`, do nothing.
   - If neighbor is `neutral` (gray), leave it unchanged.
   - Else (any opponent color) → set directly to `attacker`.
5. Result
   - No gray cells are generated.
   - Existing gray cells (if any) remain untouched by placement.


## Gray availability and guarantees
- Gray generation
  - `neutralIntermediary`: gray cells CAN be generated when converting opponents.
  - `directTransfer`: gray cells are NEVER generated by placements.
- Gray-specific actions
  - `neutralIntermediary`: gray drop is AVAILABLE (user/AI). Existing behavior preserved.
  - `directTransfer`: gray drop is DISABLED (gated in logic). Tapping gray does nothing; AI will not select gray drop.
- Existing gray cells in `directTransfer`
  - The resolution logic does not create gray cells. If a board somehow contains gray (e.g., from legacy/saved state), placement will not convert them; gray-drop logic is gated off; blows still remove them like any other non-empty cell.


## Where it is used in code
- `lib/logic/infection_resolution.dart`
  - Defines the enum and the centralized transition function.
- `lib/logic/adjacency.dart`
  - Provides the reusable neighbor iteration for infected cells.
- `lib/logic/rules_engine.dart`
  - `place(...)` calls `InfectionResolution.applyUsingDefaults(...)` after placing the attacker.
- `lib/logic/game_controller.dart`
  - Gray-related interactions are gated to `neutralIntermediary`:
    - Neutral tap handling: selection and gray-drop preview only when enabled.
    - `_performGreyDropFor(...)` and `_performGreyDropAi(...)` early-return when disabled.
    - AI decision logic considers `_AiAction.greyDrop` only when gray is enabled and neutrals exist.


## Why resolution logic must be centralized
- Consistency: One function owns all ownership transition semantics; no duplication or drift across logic, AI, and UI.
- Composability: Resolution combines cleanly with the adjacency provider, fulfilling the independence requirement from `GAMEPLAY_MODES_DESIGN.md`.
- Testability: Unit tests can target `applyOwnershipTransitions(...)` directly for both modes and varying neighbor sets.
- Extensibility: New modes (e.g., probabilistic capture, staged infection) can be added without touching consumers beyond configuration.
- Safety: Explicit gating prevents accidental use of gray mechanics when `directTransfer` is active.


## Compatibility and scope notes
- Default mode is `neutralIntermediary`, so gameplay remains 100% identical unless the mode is explicitly changed by developers.
- Scoring rules are unchanged. In `directTransfer`, gray-related scoring hooks are naturally inert because no gray transitions occur.
- UI is unchanged; gating only prevents gray-drop interactions when disabled.
- AI heuristics are unchanged; only the choice set is gated when gray is disabled.
